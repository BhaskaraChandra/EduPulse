<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Performance Table</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: auto;
      overflow: auto;
      padding: 0;
      background: #eaf0f6;
      color: #333;
      height: 100vh;
      width: 100vw;
      box-sizing: border-box;
    }
    body::-webkit-scrollbar {
      display: none;
    }

    h2 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 28px;
      color: #2c3e50;
    }

    .loadrankcard-content {
      width : 100%;
      height: 100vh;
      /* max-width: 1100px; */
      margin: auto;
      overflow: auto;
      border-radius: 12px;
      background: #ffffff;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.08);
      padding: 0px;
      border: 1px solid #8f94ad;
    }

    .loadrankcard-content::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
    }

    thead {
      background-color: #2d3436;
      color: #ffffff;
      /* position: sticky; */
      top: 0;
      z-index: 10;
    }

    th, td {
      padding: 14px 18px;
      text-align: center;
      border-bottom: 1px solid #dee2e6;
      transition: background-color 0.2s ease-in-out;
    }

    th.sortable {
      cursor: pointer;
      position: relative;
    }

    th.sortable::after {
      content: ' â‡…';
      font-size: 12px;
      color: #ccc;
      margin-left: 6px;
    }

    td:hover {
      background-color: #f1f8ff;
    }

    .badge {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      color: #fff;
    }

    .badge.accuracy {
      background-color: #27ae60;
    }

    .badge.response {
      background-color: #2980b9;
    }

    .badge.coverage {
      background-color: #f39c12;
    }

    th[colspan="3"] {
      background-color: #1f2c33;
    }

    @media (max-width: 768px) {
      th, td {
        padding: 10px;
        font-size: 14px;
      }

      .badge {
        font-size: 12px;
        padding: 5px 8px;
      }
    }
  </style>
</head>
<body>

<h2>ðŸ“ˆ Student Performance Overview</h2>

<div class="loadrankcard-content">
  <table id="studentTable">
    <thead>
      <tr>
        <th rowspan="2">Rank</th>
        <th rowspan="2" class="sortable" onclick="sortTable('studentId')">Student ID</th>
        <th rowspan="2" class="sortable" onclick="sortTable('groupId')" style="border-right: 1px solid #0084ff;">Group ID</th>
        <th colspan="3" style="border: 1px solid #0084ff;">Maths</th>
        <th colspan="3" style="border: 1px solid #0084ff;">Physics</th>
        <th colspan="3" style="border: 1px solid #0084ff;">Chemistry</th>
      </tr>
      <tr>
        <th class="sortable" onclick="sortTable('accuracy')">Accuracy</th>
        <th class="sortable" onclick="sortTable('responseTime')">Response Time</th>
        <th class="sortable" onclick="sortTable('coverage')" style="border-right: 1px solid #0084ff;">Coverage</th>
        <th class="sortable" onclick="sortTable('accuracy')">Accuracy</th>
        <th class="sortable" onclick="sortTable('responseTime')">Response Time</th>
        <th class="sortable" onclick="sortTable('coverage')" style="border-right: 1px solid #0084ff;">Coverage</th>
        <th class="sortable" onclick="sortTable('accuracy')">Accuracy</th>
        <th class="sortable" onclick="sortTable('responseTime')">Response Time</th>
        <th class="sortable" onclick="sortTable('coverage')" style="border-right: 1px solid #0084ff;">Coverage</th>
      </tr>
    </thead>
    <tbody id="tableBody">
      <!-- Table data will be injected here -->
    </tbody>
  </table>
</div>

<script>
  let originalData = [];
  let currentData = [];
  let sortDirection = {};
  mockRanksData = {'MPC-11': {'dhoni@bhaskara.com': {'Chemistry': {'Accuracy': 75.86206896551724, 'Coverage': 0.8711146307661849, 'AvgResponseTime': 8.513157894736842}, 'Math': {'Accuracy': 64.91228070175438, 'Coverage': 0.8767772511848341, 'AvgResponseTime': 15.0}, 'Physics': {'Accuracy': 90.0, 'Coverage': 0.2843601895734597, 'AvgResponseTime': 5.6}}, 'kohli@bhaskara.com': {'Chemistry': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}, 'Math': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}, 'Physics': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}}, 'bumrah@bhaskara.com': {'Chemistry': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}, 'Math': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}, 'Physics': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}}, 'lakshman@bhaskara.com': {'Chemistry': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}, 'Math': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}, 'Physics': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}}, 'sachin@bhaskara.com': {'Chemistry': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}, 'Math': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}, 'Physics': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}}, 'gavaskar@bhaskara.com': {'Chemistry': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}, 'Math': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}, 'Physics': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}}, 'rohit@bhaskara.com': {'Chemistry': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}, 'Math': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}, 'Physics': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}}, 'shubman@bhaskara.com': {'Chemistry': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}, 'Math': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}, 'Physics': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}}, 'yashaswi@bhaskara.com': {'Chemistry': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}, 'Math': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}, 'Physics': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}}, 'sarfaraz@bhaskara.com': {'Chemistry': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}, 'Math': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}, 'Physics': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}}, 'suryakumar@bhaskara.com': {'Chemistry': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}, 'Math': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}, 'Physics': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}}, 'tilak@bhaskara.com': {'Chemistry': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}, 'Math': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}, 'Physics': {'Accuracy': 0, 'Coverage': 0.0, 'AvgResponseTime': 0}}}, 'MPC-12': {'raju@bhaskara.com': {'Chemistry': {'Accuracy': 44.285714285714285, 'Coverage': 0.6137398534943576, 'AvgResponseTime': 8.902777777777779}, 'Math': {'Accuracy': 37.142857142857146, 'Coverage': 0.3080568720379147, 'AvgResponseTime': 2.914285714285714}, 'Physics': {'Accuracy': 35.0, 'Coverage': 0.2211690363349131, 'AvgResponseTime': 9.4}}}};
  function translateJsonToTableData(ranksObj)
  {
    returnData = [];
      rank = 1;
      for (const batch in ranksObj) 
      {
        for (const student in ranksObj[batch]) 
        {
          for(const subj of ["Math","Physics","Chemistry"])
          {
            //alert(subj);
            accu = ranksObj[batch][student][subj]["Accuracy"];accu=accu.toFixed(3);
            resp = ranksObj[batch][student][subj]["AvgResponseTime"];resp=resp.toFixed(3);
            covr = ranksObj[batch][student][subj]["Coverage"];covr=covr.toFixed(3);
            //{ rank: 1, studentId: "S101", groupId: "G1", subject: { accuracy: 92, responseTime: 1.2, coverage: 88 } }
            row = { rank: rank, studentId: student, groupId: batch, subject: { accuracy: 92, responseTime: 1.2, coverage: 88 } }
          }
          rank++;        
        }
      }    
      return returnData;
  }//End of translateJsonToTableData()
  formload();
  function formload()
  {  
    //alert("formloaded");
    //getRanks('{{ user.tenantName }}',["MPC-11", "MPC-12"])
    //alert(JSON.stringify(ranksObj));

    const data = [
      { rank: 1, studentId: "S101", groupId: "G1", subject: { accuracy: 92, responseTime: 1.2, coverage: 88 } },
      { rank: 2, studentId: "S102", groupId: "G2", subject: { accuracy: 85, responseTime: 0.8, coverage: 75 } },
      { rank: 3, studentId: "S103", groupId: "G1", subject: { accuracy: 90, responseTime: 1.5, coverage: 82 } },
      { rank: 4, studentId: "S104", groupId: "G3", subject: { accuracy: 88, responseTime: 1.3, coverage: 99 } }
    ];
    data = translateJsonToTableData(mockRanksData);
    return;
    originalData = [...data];
    currentData = [...data];
    sortDirection = {};
    renderTable(currentData);

  }//End Form load

  function renderTable(displayData) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    rank = 1;
    displayData.forEach(student => {
      const originalRank = originalData.find(d => d.studentId === student.studentId)?.rank || '-';
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${rank}</td>
        <td>${student.studentId}</td>
        <td>${student.groupId}</td>
        <td><span class="badge accuracy">${student.subject.accuracy}%</span></td>
        <td><span class="badge response">${student.subject.responseTime}s</span></td>
        <td><span class="badge coverage">${student.subject.coverage}%</span></td>
      `;
      tbody.appendChild(row);
      rank++;
    });
  }

    function sortTable(field) {
      const isSubjectField = ['accuracy', 'responseTime', 'coverage'].includes(field);
      const dir = sortDirection[field] === 'asc' ? 'desc' : 'asc';
      sortDirection[field] = dir;

      currentData.sort((a, b) => {
        const valA = isSubjectField ? a.subject[field] : a[field];
        const valB = isSubjectField ? b.subject[field] : b[field];

        if (typeof valA === 'string') {
          return dir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
        }
        return dir === 'asc' ? valA - valB : valB - valA;
      });

      renderTable(currentData);
      //displayRanksTable(mockRanksData)
    }//End sortTable

  function displayRanksTable(ranksObj)
  {
    //alert(JSON.stringify(ranksObj));
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      rank = 1;
      for (const batch in ranksObj) {
        //alert(batch);//console.log(`Batch: ${batch}`);
        for (const student in ranksObj[batch]) 
        {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${rank}</td>
            <td>${student}</td>
            <td style="border-right: 1px solid #0084ff;">${batch}</td>
          `;
          for(const subj of ["Math","Physics","Chemistry"])
          {
            //alert(subj);
            accu = ranksObj[batch][student][subj]["Accuracy"];accu=accu.toFixed(3);
            resp = ranksObj[batch][student][subj]["AvgResponseTime"];resp=resp.toFixed(3);
            covr = ranksObj[batch][student][subj]["Coverage"];covr=covr.toFixed(3);
            row.innerHTML += `
            <td><span class="badge accuracy">${accu}%</span></td>
            <td><span class="badge response">${resp}s</span></td>
            <td style="border-right: 1px solid #0084ff;"><span class="badge coverage">${covr}%</span></td>
          `;
          }
        tbody.appendChild(row);
        rank++;        
        }
      }
  }

  function getRanks(tenantName,userGroups)
  {
    displayRanksTable(mockRanksData);return; 
    //TODO: the above line must be commented out once the UI is ready
    //alert(tenantName + userGroups);
    postAPIRequest("{% url 'getGroupwiseRanks' %}", {
        "tenantName": tenantName,
        "userGroups": userGroups
    })
    .then((ranks) => {
      displayRanksTable(ranks);
      //return ranks;
    })
    .catch((error) => {
        console.error('Error:', error);
        alert('Failed to get Ranks: ' + error.message);
        //return {};
    });
  }
  // COMMON Functions below Soon to be moved to jsapi.js to a common location
  function postAPIRequest(api, input) {
    return new Promise((resolve, reject) => {
      var xhr = new XMLHttpRequest();
      xhr.open('POST', api, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      //xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
      xhr.send(JSON.stringify(input));
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            //alert(xhr.responseText)
            var admins = JSON.parse(xhr.responseText);
            resolve(admins);
          } else {
            let msg = xhr.statusText || 'Request failed';
            // Try to parse error message from response
            try {
              const errObj = JSON.parse(xhr.responseText);
              if (errObj && errObj.error) {
                msg = errObj.error;
              }
            } catch (e) {}
            reject(new Error(msg));
          }
        }
      };
    });
  }
  function SamplClientAPIForPOSTRequest_NEVER_CALL_THIS(tenantName,userGroups)
  {
    //alert(tenantName + userGroups);
    postAPIRequest("{% url 'getGroupwiseRanks' %}", {
        "tenantName": tenantName,
        "userGroups": userGroups
    })
    .then((ranks) => {
      alert(ranks)
    })
    .catch((error) => {
        console.error('Error:', error);
        alert('Failed to get Ranks: ' + error.message);
    });
  }

</script>

</body>
</html>